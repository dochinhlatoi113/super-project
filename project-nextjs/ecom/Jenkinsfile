pipeline {
    agent { label 'window-01-node' }

    environment {
        APP_NAME    = 'ecom-nextjs'
        DEPLOY_PATH = 'D:/laptrinh/jenskin-01-agent/deploy_path/ecom-nextjs'
        PROJECT_DIR = 'project-nextjs/ecom'
        PORT        = '3000'
        NODE_ENV    = 'production'
    }

    options {
        timestamps()
    }

    stages {

        stage('Checkout Code') {
            steps {
                git branch: 'main',
                    credentialsId: 'github-credential',
                    url: 'https://github.com/dochinhlatoi113/super-project.git'
            }
        }

        stage('Install Dependencies') {
            steps {
                bat """
                    cd /d ${PROJECT_DIR}
                    npm install
                """
            }
        }

        stage('Build Next.js') {
            steps {
                bat """
                    cd /d ${PROJECT_DIR}
                    npm run build
                """
            }
        }

        stage('Create .env.production') {
            steps {
                bat """
                    cd /d ${PROJECT_DIR}
                    (
                      echo NODE_ENV=${NODE_ENV}
                      echo PORT=${PORT}
                    ) > .env.production
                """
            }
        }

        stage('Deploy Source Code') {
            steps {
                bat """
                    echo ==== DEPLOY SOURCE CODE ====

                    if exist "${DEPLOY_PATH}" (
                        rmdir /S /Q "${DEPLOY_PATH}"
                    )

                    mkdir "${DEPLOY_PATH}"

                    robocopy ${PROJECT_DIR} "${DEPLOY_PATH}" /E /MIR
                    echo Robocopy done

                    exit 0
                """
            }
        }

        stage('Start Application') {
            steps {
                bat """
                    echo ==== START APPLICATION ====

                    cd /d ${DEPLOY_PATH}

                    REM Kill existing process on port ${PORT}
                    for /f "tokens=5" %%a in ('netstat -aon ^| find ":${PORT}" ^| find "LISTENING"') do (
                        taskkill /f /pid %%a 2>nul || echo No process found on port ${PORT}
                    )

                    REM Start application in background
                    start /B npm run start
                    timeout /t 5

                    echo Application started on port ${PORT}
                """
            }
        }

        stage('Health Check') {
            steps {
                bat """
                    echo ==== HEALTH CHECK ====
                    timeout /t 8

                    powershell -Command ^
                      "try { ^
                        Invoke-WebRequest http://localhost:${PORT} -UseBasicParsing -TimeoutSec 5; ^
                        Write-Host 'Health check OK' ^
                      } catch { ^
                        Write-Error 'Health check FAILED'; ^
                        exit 1 ^
                      }"

                    npx pm2 info ${APP_NAME}
                """
            }
        }
    }

    post {
        success {
            echo '✅ DEPLOY SUCCESS'
        }
        failure {
            echo '❌ DEPLOY FAILED'
        }
    }
}
