pipeline {
    agent { label 'window-01-node' }

    environment {
        APP_NAME    = 'ecom-nextjs'
        DEPLOY_PATH = 'D:/laptrinh/jenskin-01-agent/deploy_path/ecom-nextjs'
        PROJECT_DIR = 'project-nextjs/ecom'
        PORT        = '3000'
        NODE_ENV    = 'production'
    }

    options {
        timestamps()
    }

    stages {

        stage('Checkout Code') {
            steps {
                git branch: 'main',
                    credentialsId: 'github-credential',
                    url: 'https://github.com/dochinhlatoi113/super-project.git'
            }
        }

        stage('Install Dependencies') {
            steps {
                bat """
                    cd /d ${PROJECT_DIR}
                    npm install
                    npm install pm2 --save-dev
                """
            }
        }

        stage('Build Next.js') {
            steps {
                bat """
                    cd /d ${PROJECT_DIR}
                    npm run build
                """
            }
        }

        stage('Create .env.production') {
            steps {
                bat """
                    cd /d ${PROJECT_DIR}
                    (
                      echo NODE_ENV=${NODE_ENV}
                      echo PORT=${PORT}
                    ) > .env.production
                """
            }
        }

        stage('Deploy Source Code') {
            steps {
                bat """
                    echo ==== DEPLOY SOURCE CODE ====

                    if exist "${DEPLOY_PATH}" (
                        rmdir /S /Q "${DEPLOY_PATH}"
                    )

                    mkdir "${DEPLOY_PATH}"

                    robocopy ${PROJECT_DIR} "${DEPLOY_PATH}" /E /MIR
                    echo Robocopy done

                    exit 0
                """
            }
        }

        stage('Start Application') {
            steps {
                bat """
                    echo ==== START APPLICATION ====

                    cd /d ${DEPLOY_PATH}

                    npx pm2 delete ${APP_NAME} || echo App not exists
                    npx pm2 start npm --name ${APP_NAME} -- run start
                    npx pm2 save
                    npx pm2 list
                """
            }
        }

        stage('Health Check') {
            steps {
                bat """
                    echo ==== HEALTH CHECK ====
                    timeout /t 8

                    powershell -Command ^
                      "try { ^
                        Invoke-WebRequest http://localhost:${PORT} -UseBasicParsing -TimeoutSec 5; ^
                        Write-Host 'Health check OK' ^
                      } catch { ^
                        Write-Error 'Health check FAILED'; ^
                        exit 1 ^
                      }"

                    npx pm2 info ${APP_NAME}
                """
            }
        }
    }

    post {
        success {
            echo '✅ DEPLOY SUCCESS'
        }
        failure {
            echo '❌ DEPLOY FAILED'
        }
    }
}
