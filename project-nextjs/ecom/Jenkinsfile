pipeline {
    agent {
        label 'window-01-node'  // Ch·∫°y tr√™n Windows node
    }
    
    // T·ª± ƒë·ªông trigger khi push code l√™n GitHub
    triggers {
        pollSCM('H/2 * * * *')  // Check GitHub m·ªói 2 ph√∫t
    }
    
    environment {
        // Th√¥ng tin app
        APP_NAME = 'ecom-nextjs'
        
        // ‚ö†Ô∏è THAY ƒê·ªîI ƒë∆∞·ªùng d·∫´n deploy tr√™n Windows
        DEPLOY_PATH = 'D:\\laptrinh\\jenskin-01-agent\\deloy_path\\ecom-nextjs'  // V√≠ d·ª•
        // Ho·∫∑c: 'C:\\inetpub\\wwwroot\\ecom-nextjs'
        
        // ƒê∆∞·ªùng d·∫´n project trong repo
        PROJECT_DIR = 'project-nextjs/ecom'
        
        // Next.js config
        PORT = '3000'
        NODE_ENV = 'production'
    }
    
    stages {
        stage('Cleanup Workspace') {
            steps {
                echo 'üßπ Cleaning workspace...'
                deleteDir()
            }
        }
        
        stage('Checkout Code') {
            steps {
                echo 'üì• Pulling code from GitHub...'
                git branch: 'main',
                    credentialsId: 'github-credential',  // ‚ö†Ô∏è Thay ID credentials c·ªßa b·∫°n
                    url: 'https://github.com/dochinhlatoi113/super-project.git'
                
                script {
                    bat '''
                        echo === Git Info ===
                        git log -1 --pretty=format:"Commit: %%h" && echo.
                        git log -1 --pretty=format:"Author: %%an" && echo.
                        git log -1 --pretty=format:"Message: %%s" && echo.
                    '''
                }
            }
        }
        
        stage('Navigate to Project') {
            steps {
                echo "üìÇ Project location: ${PROJECT_DIR}"
                bat """
                    cd ${PROJECT_DIR}
                    dir
                    echo Current directory:
                    cd
                """
            }
        }
        
        stage('Check Environment') {
            steps {
                echo '‚öôÔ∏è Checking Node.js and npm...'
                bat '''
                    echo Node version:
                    node --version
                    echo NPM version:
                    npm --version
                    echo PM2 version:
                    pm2 --version || echo PM2 not installed
                '''
            }
        }
        
        stage('Install Dependencies') {
            steps {
                echo 'üì¶ Installing dependencies...'
                bat """
                    cd ${PROJECT_DIR}
                    echo Installing npm packages...
                    npm install
                """
            }
        }
        
        stage('Create Environment File') {
            steps {
                echo '‚öôÔ∏è Creating .env.production...'
                bat """
                    cd ${PROJECT_DIR}
                    (
                    echo NODE_ENV=production
                    echo PORT=${PORT}
                    echo.
                    echo # API Configuration
                    echo # NEXT_PUBLIC_API_URL=https://api.example.com
                    echo # NEXT_PUBLIC_API_KEY=your-api-key
                    echo.
                    echo # Database (n·∫øu Next.js k·∫øt n·ªëi tr·ª±c ti·∫øp DB)
                    echo # DATABASE_URL=postgresql://user:password@localhost:5432/dbname
                    echo.
                    echo # Other environment variables
                    echo # NEXT_PUBLIC_SITE_URL=http://localhost:${PORT}
                    ) > .env.production
                    
                    echo Environment file created:
                    type .env.production
                """
            }
        }
        
        stage('Run Tests') {
            steps {
                echo 'üß™ Running tests...'
                script {
                    try {
                        bat """
                            cd ${PROJECT_DIR}
                            npm test || echo No tests configured
                        """
                    } catch (Exception e) {
                        echo "‚ö†Ô∏è Tests failed: ${e.message}"
                    }
                }
            }
        }
        
        stage('Build Next.js') {
            steps {
                echo 'üî® Building Next.js application...'
                bat """
                    cd ${PROJECT_DIR}
                    echo Building Next.js...
                    npm run build
                    
                    echo Build completed, checking .next folder:
                    dir .next
                """
            }
        }
        
        stage('Backup Current Version') {
            steps {
                echo 'üíæ Backing up current deployment...'
                script {
                    bat """
                        if exist "${DEPLOY_PATH}" (
                            echo Creating backup...
                            set BACKUP_DIR=${DEPLOY_PATH}.backup.%date:~-4,4%%date:~-10,2%%date:~-7,2%_%time:~0,2%%time:~3,2%%time:~6,2%
                            set BACKUP_DIR=!BACKUP_DIR: =0!
                            xcopy /E /I /Y "${DEPLOY_PATH}" "!BACKUP_DIR!"
                            echo Backup created: !BACKUP_DIR!
                        ) else (
                            echo No existing deployment to backup
                        )
                    """
                }
            }
        }
        
        stage('Deploy to Server') {
            steps {
                echo 'üöÄ Deploying application...'
                bat """
                    echo Creating deploy directory...
                    if not exist "${DEPLOY_PATH}" mkdir "${DEPLOY_PATH}"
                    
                    echo Copying files to ${DEPLOY_PATH}...
                    cd ${PROJECT_DIR}
                    
                    REM Copy important files and folders
                    xcopy /E /I /Y .next "${DEPLOY_PATH}\\.next"
                    xcopy /E /I /Y public "${DEPLOY_PATH}\\public"
                    xcopy /E /I /Y node_modules "${DEPLOY_PATH}\\node_modules"
                    copy /Y package.json "${DEPLOY_PATH}\\package.json"
                    copy /Y package-lock.json "${DEPLOY_PATH}\\package-lock.json" 2>nul || echo No package-lock.json
                    copy /Y next.config.js "${DEPLOY_PATH}\\next.config.js" 2>nul || echo No next.config.js
                    copy /Y .env.production "${DEPLOY_PATH}\\.env.production"
                    
                    echo Deployment completed
                    dir "${DEPLOY_PATH}"
                """
            }
        }
        
        stage('Install Production Dependencies') {
            steps {
                echo 'üì¶ Installing production dependencies...'
                bat """
                    cd ${DEPLOY_PATH}
                    npm install --production
                """
            }
        }
        
        stage('Stop Current Application') {
            steps {
                echo 'üõë Stopping current application...'
                script {
                    bat """
                        REM Stop PM2 process if exists
                        pm2 stop ${APP_NAME} || echo App not running
                        pm2 delete ${APP_NAME} || echo App not in PM2
                        
                        REM Alternative: Kill by port
                        REM for /f "tokens=5" %%a in ('netstat -aon ^| find ":${PORT}" ^| find "LISTENING"') do taskkill /F /PID %%a || echo No process on port ${PORT}
                    """
                }
            }
        }
        
        stage('Start Application') {
            steps {
                echo '‚ñ∂Ô∏è Starting Next.js application...'
                bat """
                    cd ${DEPLOY_PATH}
                    
                    REM Check if PM2 is installed
                    where pm2 >nul 2>nul
                    if %ERRORLEVEL% EQU 0 (
                        echo Starting with PM2...
                        pm2 start npm --name ${APP_NAME} -- start
                        pm2 save
                        pm2 list
                    ) else (
                        echo PM2 not found! Install it: npm install -g pm2
                        echo Starting app directly...
                        start /B npm start
                    )
                """
            }
        }
        
        stage('Health Check') {
            steps {
                echo 'üíö Checking application health...'
                script {
                    bat """
                        echo Waiting 10 seconds for app to start...
                        timeout /t 10 /nobreak
                        
                        REM Check if app is responding
                        curl -f http://localhost:${PORT} || echo Warning: App may not be responding
                        
                        REM Show PM2 status
                        pm2 info ${APP_NAME} || echo PM2 not managing the app
                        
                        REM Show processes on port
                        netstat -ano | findstr ":${PORT}"
                    """
                }
            }
        }
    }
    
    post {
        success {
            echo '‚úÖ =============================================='
            echo '‚úÖ DEPLOYMENT SUCCESSFUL!'
            echo '‚úÖ =============================================='
            echo "üì¶ Application: ${APP_NAME}"
            echo "üìç Deployed to: ${DEPLOY_PATH}"
            echo "üåê URL: http://localhost:${PORT}"
            echo "üìä Check logs: pm2 logs ${APP_NAME}"
            echo '‚úÖ =============================================='
        }
        
        failure {
            echo '‚ùå =============================================='
            echo '‚ùå DEPLOYMENT FAILED!'
            echo '‚ùå =============================================='
            
            script {
                bat """
                    echo Attempting rollback...
                    
                    REM Find latest backup
                    for /f "delims=" %%i in ('dir /b /ad /o-d "${DEPLOY_PATH}.backup.*" 2^>nul') do (
                        set LATEST_BACKUP=%%i
                        goto :found
                    )
                    :found
                    
                    if defined LATEST_BACKUP (
                        echo Rolling back to !LATEST_BACKUP!
                        rmdir /S /Q "${DEPLOY_PATH}"
                        xcopy /E /I /Y "!LATEST_BACKUP!" "${DEPLOY_PATH}"
                        
                        cd ${DEPLOY_PATH}
                        pm2 restart ${APP_NAME} || npm start
                        echo Rollback completed
                    ) else (
                        echo No backup found for rollback
                    )
                """
            }
        }
        
        always {
            echo 'üèÅ Pipeline execution finished'
        }
    }
}
