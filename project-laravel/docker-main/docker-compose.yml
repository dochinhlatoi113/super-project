version: '3.9'

services:
    phpmyadmin:
        image: phpmyadmin/phpmyadmin:latest
        container_name: laravel_phpmyadmin
        restart: unless-stopped
        environment:
            PMA_HOST: mysql
            PMA_PORT: 3306
            PMA_USER: root
            PMA_PASSWORD: root
        ports:
            - '8080:80'
        depends_on:
            - mysql
        networks:
            - laravel

    php:
        build:
            context: ./php
            dockerfile: Dockerfile
        container_name: laravel_php
        restart: unless-stopped
        working_dir: /var/www/html
        environment:
            - APP_ENV=local
            - KAFKA_BROKERS=kafka:9092
        volumes:
            - ../src:/var/www/html:cached
            - ./php/supervisord.conf:/etc/supervisor/conf.d/supervisord.conf:ro
        depends_on:
            - mysql
            - redis
            - elasticsearch
            - kafka
        networks:
            - laravel

    nginx:
        image: nginx:stable
        container_name: laravel_nginx
        restart: unless-stopped
        ports:
            - '80:80'
        volumes:
            - ../src:/var/www/html:ro
            - ./nginx/conf.d/default.conf:/etc/nginx/conf.d/default.conf:ro
        depends_on:
            - php
        networks:
            - laravel

    mysql:
        image: mysql:8.0
        container_name: laravel_mysql
        restart: unless-stopped
        environment:
            MYSQL_ROOT_PASSWORD: root
            MYSQL_DATABASE: laravel
            MYSQL_USER: laravel
            MYSQL_PASSWORD: laravel
        ports:
            - '3306:3306'
        volumes:
            - mysql_data:/var/lib/mysql
            - ./mysql/my.cnf:/etc/mysql/conf.d/my.cnf:ro
        networks:
            - laravel

    redis:
        image: redis:7-alpine
        container_name: laravel_redis
        restart: unless-stopped
        ports:
            - '6379:6379'
        volumes:
            - redis_data:/data
        networks:
            - laravel

    mongodb:
        image: mongo:7
        container_name: laravel_mongodb
        restart: unless-stopped
        environment:
            MONGO_INITDB_ROOT_USERNAME: root
            MONGO_INITDB_ROOT_PASSWORD: root
            MONGO_INITDB_DATABASE: nodejs_auth
        ports:
            - '27017:27017'
        volumes:
            - mongodb_data:/data/db
            - mongodb_config:/data/configdb
        networks:
            - laravel

    mongo-express:
        image: mongo-express:latest
        container_name: laravel_mongo_express
        restart: unless-stopped
        environment:
            ME_CONFIG_MONGODB_ADMINUSERNAME: root
            ME_CONFIG_MONGODB_ADMINPASSWORD: root
            ME_CONFIG_MONGODB_URL: mongodb://root:root@mongodb:27017/
            ME_CONFIG_BASICAUTH: false
        ports:
            - '8081:8081'
        depends_on:
            - mongodb
        networks:
            - laravel

    queue:
        build:
            context: ./php
            dockerfile: Dockerfile
        container_name: laravel_queue
        restart: unless-stopped
        working_dir: /var/www/html
        command: supervisord -n
        environment:
            - KAFKA_BROKERS=kafka:9092
        volumes:
            - ../src:/var/www/html:cached
            - ./php/supervisord.conf:/etc/supervisor/conf.d/supervisord.conf:ro
        depends_on:
            - php
            - redis
            - kafka
        networks:
            - laravel

    elasticsearch:
        image: docker.elastic.co/elasticsearch/elasticsearch:8.8.2
        container_name: laravel_elasticsearch
        environment:
            - discovery.type=single-node
            - bootstrap.memory_lock=true
            - ES_JAVA_OPTS=-Xms512m -Xmx512m
            - xpack.security.enabled=false
        ulimits:
            memlock:
                soft: -1
                hard: -1
        ports:
            - '9200:9200'
        volumes:
            - esdata:/usr/share/elasticsearch/data
        networks:
            - laravel

    logstash:
        image: docker.elastic.co/logstash/logstash:8.8.2
        container_name: laravel_logstash
        restart: unless-stopped
        environment:
            - xpack.monitoring.enabled=false
            - ELASTICSEARCH_HOSTS=http://elasticsearch:9200
            # Credentials for Elasticsearch access by Logstash - set at runtime or via .env/docker secrets
            - LOGSTASH_ES_USERNAME=elastic
            - LOGSTASH_ES_PASSWORD=msWrVIxIVyrLgXPwfZj4
        ports:
            - '5001:5000'
            - '5044:5044'
            - '9600:9600'
        volumes:
            - ./logstash/pipeline:/usr/share/logstash/pipeline:ro
            - logstash_data:/usr/share/logstash/data
        depends_on:
            - elasticsearch
        networks:
            - laravel

    kibana:
        image: docker.elastic.co/kibana/kibana:8.8.2
        container_name: laravel_kibana
        restart: unless-stopped
        platform: linux/amd64
        environment:
            - ELASTICSEARCH_HOSTS=http://elasticsearch:9200
            - SERVER_NAME=kibana.local
        ports:
            - '5601:5601'
        depends_on:
            - elasticsearch
        networks:
            - laravel

    filebeat:
        image: docker.elastic.co/beats/filebeat:8.8.2
        container_name: laravel_filebeat
        restart: unless-stopped
        user: root
        volumes:
            - ../src:/var/www/html:ro
            - ./filebeat/filebeat.yml:/usr/share/filebeat/filebeat.yml:ro
        depends_on:
            - logstash
        networks:
            - laravel

    zookeeper:
        image: confluentinc/cp-zookeeper:7.5.0
        container_name: laravel_zookeeper
        restart: unless-stopped
        environment:
            ZOOKEEPER_CLIENT_PORT: 2181
            ZOOKEEPER_TICK_TIME: 2000
        ports:
            - '2181:2181'
        volumes:
            - zookeeper_data:/var/lib/zookeeper/data
            - zookeeper_logs:/var/lib/zookeeper/log
        networks:
            - laravel

    kafka:
        image: confluentinc/cp-kafka:7.5.0
        container_name: laravel_kafka
        restart: unless-stopped
        ports:
            - '9092:9092'
            - '29092:29092'
        environment:
            KAFKA_BROKER_ID: 1
            KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181

            KAFKA_LISTENERS: PLAINTEXT://0.0.0.0:9092,PLAINTEXT_HOST://0.0.0.0:29092
            KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092,PLAINTEXT_HOST://localhost:29092
            KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
            KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT

            KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
            KAFKA_AUTO_CREATE_TOPICS_ENABLE: 'true'
        depends_on:
            - zookeeper
        volumes:
            - kafka_data:/var/lib/kafka/data
        networks:
            - laravel

volumes:
    mysql_data:
    redis_data:
    mongodb_data:
    mongodb_config:
    esdata:
    logstash_data:
    zookeeper_data:
    zookeeper_logs:
    kafka_data:

networks:
    laravel:
        driver: bridge
